---
- hosts: all
  tasks:
    - name: Bootstrap bastion node using ansible
      args:
        chdir: "{{ windmill_src_dir }}"
      shell: tox -evenv -- ansible-playbook -i inventory/testing/hosts playbooks/bastion.yaml

    - name: Install ansible roles via galaxy
      args:
        chdir: "{{ windmill_src_dir }}"
        executable: /bin/bash
      shell: source /opt/venv/ansible/bin/activate; ./tools/install_roles.sh

    - name: Run ansible-playbook for site.yaml
      args:
        chdir: "{{ windmill_src_dir }}"
      shell: "/opt/venv/ansible/bin/ansible-playbook -v -f1 -i inventory/testing/hosts playbooks/site.yaml -e @{{ windmill_extra_vars_file }}"

    - name: Run ansible-playbook for prove.yaml
      args:
        chdir: "{{ windmill_src_dir }}"
      shell: /opt/venv/ansible/bin/ansible-playbook -i inventory/testing/hosts playbooks/prove.yaml
