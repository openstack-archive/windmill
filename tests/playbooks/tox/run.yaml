- hosts: all
  tasks:
    - name: Bootstrap tox environment
      args:
        chdir: "{{ zuul.project.src_dir }}"
      command: tox -evenv --notest

    - name: Install bindep dependendies
      args:
        chdir: "{{ zuul.project.src_dir }}"
      shell: source .tox/venv/bin/activate; ./tools/install_bindep.sh

    - name: Install ansible roles via galaxy
      args:
        chdir: "{{ zuul.project.src_dir }}"
      shell: source .tox/venv/bin/activate; ./tools/install_roles.sh

    - name: Run ansible-playbook for bastion
      args:
        chdir: "{{ zuul.project.src_dir }}"
      shell: source .tox/venv/bin/activate; ansible-playbook -v -i inventory/single-node playbooks/bastion.yaml
