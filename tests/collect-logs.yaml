- hosts: localhost
  tasks:
    - name: Ensure logs directory exists
      file:
        path: "{{ item }}"
        state: directory
      with_items:
        - "{{ zuul.executor.log_root }}/logs"
        - "{{ zuul.executor.log_root }}/logs/gear01/var/log"
        - "{{ zuul.executor.log_root }}/logs/nb01/var/log"
        - "{{ zuul.executor.log_root }}/logs/nl01/var/log"
        - "{{ zuul.executor.log_root }}/logs/statsd01/var/log"
        - "{{ zuul.executor.log_root }}/logs/ze01/var/log"
        - "{{ zuul.executor.log_root }}/logs/zf01/var/log"
        - "{{ zuul.executor.log_root }}/logs/zm01/var/log"
        - "{{ zuul.executor.log_root }}/logs/zs01/var/log"
        - "{{ zuul.executor.log_root }}/logs/zw01/var/log"

- hosts: statsd01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - statsd

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect statsd log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/statsd
        - /var/log/statsd

- hosts: gear01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - gear

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect gear log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/gear
        - /var/log/gear

- hosts: nb01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - nodepool-builder

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect nodepool log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/nodepool/builder-logging.conf
        - /etc/nodepool/nodepool.yaml
        - /var/log/nodepool/builds/*.log
        - /var/log/nodepool/builder-debug.log
        - /var/log/nodepool/nodepool-builder.log

- hosts: nl01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - nodepool-launcher

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect nl01 log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/nodepool/launcher-logging.conf
        - /etc/nodepool/nodepool.yaml
        - /var/log/nodepool/launcher-debug.log
        - /var/log/nodepool/nodepool-launcher.log

- hosts: ze01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - zuul-executor

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect ze01 log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/executor-logging.conf
        - /etc/zuul/config
        - /etc/zuul/zuul.conf
        - /var/log/zuul/executor-debug.log
        - /var/log/zuul/executor.log

- hosts: zf01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - zuul-fingergw

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect zf01 log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname}}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/fingergw-logging.conf
        - /etc/zuul/config
        - /etc/zuul/zuul.conf
        - /var/log/zuul/fingergw-debug.log
        - /var/log/zuul/fingergw.log

- hosts: zm01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - zuul-merger

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect zm01 log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/config
        - /etc/zuul/merger-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/merger-debug.log
        - /var/log/zuul/merger.log

- hosts: zs01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - zuul-scheduler

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect zs01 log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/config
        - /etc/zuul/scheduler-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/scheduler-debug.log
        - /var/log/zuul/scheduler.log

- hosts: zw01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/journal"
        state: directory

    - name: Collect journald logs
      become: yes
      shell: "journalctl -u {{ item }}.service > /home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      args:
        creates: "/home/{{ ansible_user }}/logs/{{ inventory_hostname }}/journal/{{ item }}.service.log"
      with_items:
        - zuul-web

    - name: Collect journald log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}/var/log"
        mode: pull
        src: "~/logs/{{ inventory_hostname }}/journal"
        verify_host: true

    - name: Collect zw01 log files
      synchronize:
        dest: "{{ zuul.executor.log_root }}/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/config
        - /etc/zuul/web-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/web-debug.log
        - /var/log/zuul/web.log
