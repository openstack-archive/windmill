- hosts: statsd01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "{{ zuul_output_dir }}/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee {{ zuul_output_dir }}/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "{{ zuul_output_dir }}/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - statsd

    - name: Collect statsd log files
      become: yes
      synchronize:
        dest: "{{ zuul_output_dir }}/logs/{{ inventory_hostname }}"
        rsync_opts:
          - "--relative"
          - "--chown={{ ansible_user_id }}:{{ ansible_user_id }}"
        src: "{{ item }}"
        verify_host: true
      delegate_to: "{{ statsd01 }}"
      with_items:
        - /etc/statsd
        - /var/log/statsd

    # TODO: Migrate to fetch-zuul-logs when
    # https://review.openstack.org/#/c/583346/ is merged.
    - name: Collect log output
      synchronize:
        dest: "{{ zuul.executor.log_root }}/"
        mode: pull
        src: "{{ zuul_output_dir }}/logs/"
        verify_host: true

- hosts: gear01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - gear

    - name: Collect gear log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/gear/logging.conf
        - /var/log/gear/*.log

- hosts: nb01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - nodepool-builder

    - name: Collect nodepool log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/nodepool/builder-logging.conf
        - /etc/nodepool/nodepool.yaml
        - /var/log/nodepool/builds/*.log
        - /var/log/nodepool/builder-debug.log
        - /var/log/nodepool/nodepool-builder.log

- hosts: nl01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - nodepool-launcher

    - name: Collect nl01 log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/nodepool/launcher-logging.conf
        - /etc/nodepool/nodepool.yaml
        - /var/log/nodepool/launcher-debug.log
        - /var/log/nodepool/nodepool-launcher.log

- hosts: zs01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - zuul-scheduler

    - name: Collect zs01 log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/main.yaml
        - /etc/zuul/scheduler-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/scheduler-debug.log
        - /var/log/zuul/scheduler.log

- hosts: ze01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - zuul-executor

    - name: Collect ze01 log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/executor-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/executor-debug.log
        - /var/log/zuul/executor.log

- hosts: zf01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - zuul-fingergw

    - name: Collect zf01 log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname}}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/fingergw-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/fingergw-debug.log
        - /var/log/zuul/fingergw.log

- hosts: zm01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - zuul-merger

    - name: Collect zm01 log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/merger-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/merger-debug.log
        - /var/log/zuul/merger.log

- hosts: zw01
  tasks:
    - name: Ensure journald logs directory exists
      file:
        path: "~/logs/{{ inventory_hostname }}/var/log/journal"
        state: directory

    - name: Collect journald logs
      shell: "sudo journalctl -u {{ item }}.service | tee ~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      args:
        creates: "~/logs/{{ inventory_hostname }}/var/log/journal/{{ item }}.service.log"
      with_items:
        - zuul-web

    - name: Collect zw01 log files
      synchronize:
        dest: "~/logs/{{ inventory_hostname }}"
        mode: pull
        recursive: false
        rsync_opts:
          - "--relative"
        src: "{{ item }}"
        verify_host: true
      with_items:
        - /etc/zuul/web-logging.conf
        - /etc/zuul/zuul.conf
        - /var/log/zuul/web-debug.log
        - /var/log/zuul/web.log
